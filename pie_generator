Sub CreatePieChartsForRow()
    Dim ws As Worksheet
    Set ws = ActiveSheet

    Dim r As Long ' 行号
    Dim chartCount As Integer ' 计数器，用于每行的图表布局
    Dim chtTop As Long ' 图表顶部位置
    Dim chtLeft As Long ' 图表左侧位置

    For r = 1 To 8
        Dim normalDays As Long, abnormalDays As Long, consecutiveZeros As Long
        Dim maxConsecutiveZeros As Long, currentCell As Range

        normalDays = 0
        abnormalDays = 0
        consecutiveZeros = 0
        maxConsecutiveZeros = 0
        chartCount = (r - 1) Mod 4 ' 每4个图表换行

        ' 计算1和0的数量，连续0的最大数量
        For Each currentCell In ws.Rows(r).Cells
            If currentCell.Value = 1 Then
                normalDays = normalDays + 1
                consecutiveZeros = 0
            ElseIf currentCell.Value = 0 Then
                abnormalDays = abnormalDays + 1
                consecutiveZeros = consecutiveZeros + 1
                If consecutiveZeros > maxConsecutiveZeros Then
                    maxConsecutiveZeros = consecutiveZeros
                End If
            End If
        Next currentCell

        ' 为每行创建饼图
        chtTop = 50 + Int((r - 1) / 4) * 250 ' 每4行改变顶部位置
        chtLeft = 100 + chartCount * 150 ' 改变左侧位置以避免重叠

        Dim cht As ChartObject
        Set cht = ws.ChartObjects.Add(Left:=chtLeft, Width:=140, Top:=chtTop, Height:=225)
        With cht.Chart
            .ChartType = xlPie
            .SeriesCollection.NewSeries
            .SeriesCollection(1).Values = Array(normalDays, abnormalDays)
            .SeriesCollection(1).XValues = Array("Normal", "Abnormal")

            ' 如果连续超过3个0，为0部分添加边框
            If maxConsecutiveZeros > 3 Then
                With .SeriesCollection(1).Points(2).Format.Line
                    .Visible = msoTrue
                    .ForeColor.RGB = RGB(255, 0, 0) ' 红色
                    .Weight = 2 ' 边框宽度
                End With
            Else
                .SeriesCollection(1).Points(2).Format.Line.Visible = msoFalse
            End If
        End With
    Next r
End Sub
